<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="icon" href="/favicon.ico"/><meta name="description" content="Francis Tao-Jinjin Next.js GitHub Pages"/><meta property="og:image" content="https://og-image.now.sh/Francis%20Tao-Jinjin%20Next.js%20GitHub%20Pages.png?theme=light&amp;md=0&amp;fontSize=75px&amp;images=https%3A%2F%2Fassets.vercel.com%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fnextjs-black-logo.svg"/><meta name="og:title" content="Francis Tao-Jinjin Next.js GitHub Pages"/><meta name="teitter:card" content="summary_large_image"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/default.min.css"/><title>3D UI of Box3 Game Editor</title><meta name="next-head-count" content="9"/><link rel="preload" href="/_next/static/css/525ade0da8ac601406c9.css" as="style"/><link rel="stylesheet" href="/_next/static/css/525ade0da8ac601406c9.css" data-n-g=""/><link rel="preload" href="/_next/static/css/7c37ee6f4b99f4530db0.css" as="style"/><link rel="stylesheet" href="/_next/static/css/7c37ee6f4b99f4530db0.css" data-n-g=""/><link rel="preload" href="/_next/static/css/ca491a2f2dad37bc344d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ca491a2f2dad37bc344d.css" data-n-p=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-fcbdb94e906b93a1f560.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.9d524150d48315f49e80.js" as="script"/><link rel="preload" href="/_next/static/chunks/7a55d4b5.210d3c80a2b0e2401248.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.ff0a5790a80e83d7223b.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-5d53db12a2c7a352dba7.js" as="script"/><link rel="preload" href="/_next/static/chunks/df27990eef8845831ef4a3353c0adb327953b68f.b37cb412c978ebbef724.js" as="script"/><link rel="preload" href="/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.a80097bea88316e5b19e.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bid%5D-dd642f1262e5265a6db6.js" as="script"/></head><body><div id="__next"><div class="layout_container__2t4v2"><header class="layout_header__2rhWq"><a href="/"><img src="/images/profile.png" class="layout_headerImage__2h5On utils_borderCircle__13qdJ" alt="Francis Tao"/></a><h2 class="utils_headingLg__de7p0"><a class="utils_colorInherit__3Gudf" href="/">Francis Tao</a></h2></header><article><h1 class="utils_headingXl__1XecN">3D UI of Box3 Game Editor</h1><div class="utils_lightText__12Ckm"><time dateTime="2019-08-12">August 12, 2019</time></div><div><div class='markdown'></div>
<h2 class="text-xl font-medium mb-2 mt-3">Combine Webgl and React to create 3d UI</h2>
<p>In modeling software and game editors, 3dUI is an indispensable part, through which user can intuitively manipulate the objects they edit. Some common 3dUIs are looks like:</p>
<div class='m-5'></div>
<img src="/images/3d-ui/manipulators.png" alt="common 3dUIs" style="width:800px; margin:auto"/>
<div class='m-5'></div>
<p>In the Box3 game editor, we also need such manipulators. If we think about it a little bit, we will find that these 3d ui and ordinary React components actually have a lot in common. For example, they can be easily created and destroyed, they can accept props to calculate the initial state, and they have to actively respond to the user’s actions (translation, rotation, scale).</p>
<div class='m-5'></div>
<p>That why we want to use the lifecycle of traditional React components to control the creation and destruction of 3d UI. But here’s another problem, the data used in webgl is outside of React, but with the React Context API, we can inject that data into React.</p>
<div class='m-5'></div>
<p>Here is the diagram show how this system was designed.</p>
<div class='m-5'></div>
<img src="/images/3d-ui/diagram.png" alt="system design diagram" style="width:500px; margin:auto"/>
<div class='m-5'></div>
<h3 class="text-xl font-medium mb-2 mt-3">So, what exactly is a 3dUI? </h3>
<div class='m-5'></div>
<p>If you look at it from a React’s perspective, the combination of a <code>UI3DContext.Consumer</code> and a <code>EliminateWrapper</code> in the diagram is a 3dUI component. If you look at it from the perspective of the WebGL rendering engine, then the 3dUI data generated by the <code>UI3DContext.Consumer</code> is actually a 3dUI Element.</p>
<p>At the specific code implementation level, we use <a class="text-blue-700" href="https://github.com/mikolalysenko/mudb">Mudb</a> to build the schema of UI3dState.(Mudb is the core opensource library that we use in ‘Box3’, it was build by our team). You may use any method you like, but the overall design pattern has shown in the diagram.</p>
<p>The simplest example would be a 3d Point(or you can call it Sphere), I will use it for a detailed demonstration.
First, we define the schema for UI3DState and UI3DSphere.</p>
<div class='preCodeBlock'></div>
<pre><code class="language-Typescript"><span class="hljs-comment">// define mouse event schema</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> UI3DMouseEventSchema = <span class="hljs-keyword">new</span> MuStruct({
    <span class="hljs-attr">eye</span>: Vec3Schema,
    <span class="hljs-attr">mouseButton</span>: <span class="hljs-keyword">new</span> MuUint8(),
    <span class="hljs-attr">mouseState</span>: <span class="hljs-keyword">new</span> MuUint8(),
    <span class="hljs-attr">worldPosition</span>: Vec3Schema,
    <span class="hljs-attr">screenPosition</span>: Vec2Schema,
});
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> UI3DMouseEvent = <span class="hljs-keyword">typeof</span> UI3DMouseEventSchema.identity;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> UI3DMouseHandler = <span class="hljs-function">(<span class="hljs-params">event:UI3DMouseEvent</span>) =&gt;</span> <span class="hljs-built_in">boolean</span>;

<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UI3DEventHandlerNode</span> </span>{
    <span class="hljs-keyword">public</span> next:UI3DEventHandlerNode|<span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">public</span> prev:UI3DEventHandlerNode|<span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
}

<span class="hljs-comment">// Schema for UI3DSphere</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> UI3DSphereSchema = <span class="hljs-keyword">new</span> MuStruct({
    <span class="hljs-attr">id</span>: <span class="hljs-keyword">new</span> MuUint32(),
    <span class="hljs-attr">destroyed</span>: <span class="hljs-keyword">new</span> MuBoolean(<span class="hljs-literal">false</span>),
    <span class="hljs-attr">position</span>: Vec3Schema,
    <span class="hljs-attr">radius</span>: <span class="hljs-keyword">new</span> MuFloat64(<span class="hljs-number">1</span>),
    <span class="hljs-attr">color</span>: Vec3Schema,
    <span class="hljs-attr">onMouseChange</span>: <span class="hljs-keyword">new</span> MuRefSchema&lt;UI3DMouseHandler&gt;(),
});

<span class="hljs-comment">// you can define more different kind of UI3DElement</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> UI3DElementSchema = <span class="hljs-keyword">new</span> MuUnion({
    <span class="hljs-attr">point</span>: UI3DSphereSchema,
});
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> UI3DElement = <span class="hljs-keyword">typeof</span> UI3DElementSchema.identity;

<span class="hljs-comment">// an event record</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> UI3DEventSchema = <span class="hljs-keyword">new</span> MuStruct({
    <span class="hljs-comment">// hit distance</span>
    <span class="hljs-attr">hitDistance</span>: <span class="hljs-keyword">new</span> MuFloat64(),
    <span class="hljs-comment">// event type</span>
    <span class="hljs-attr">event</span>: <span class="hljs-keyword">new</span> MuUnion({
        <span class="hljs-attr">mouse</span>: UI3DMouseEventSchema,
    }),
    <span class="hljs-comment">// event handler</span>
    <span class="hljs-attr">handler</span>: <span class="hljs-keyword">new</span> MuRefSchema&lt;<span class="hljs-function">(<span class="hljs-params">event:<span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">boolean</span>&gt;(),
});
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> UI3DEventQueueSchema = <span class="hljs-keyword">new</span> MuArray(UI3DEventSchema, <span class="hljs-literal">Infinity</span>);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> UI3DEventQueue = <span class="hljs-keyword">typeof</span> UI3DEventQueueSchema.identity;

<span class="hljs-comment">// Schema for UI3DState</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> UI3DStateSchema = <span class="hljs-keyword">new</span> MuStruct({
    <span class="hljs-attr">idCounter</span>: <span class="hljs-keyword">new</span> MuUint32(),

    <span class="hljs-comment">// elements list</span>
    <span class="hljs-attr">elements</span>: <span class="hljs-keyword">new</span> MuArray(UI3DElementSchema, <span class="hljs-literal">Infinity</span>),

    <span class="hljs-comment">// event handler list</span>
    <span class="hljs-attr">eventHandlers</span>: <span class="hljs-keyword">new</span> MuRefSchema&lt;UI3DEventHandlerNode&gt;(),

    <span class="hljs-comment">// previous event handler list</span>
    <span class="hljs-attr">prevEventStack</span>: UI3DEventQueueSchema,
});
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> UI3DState = <span class="hljs-keyword">typeof</span> UI3DStateSchema.identity;
</code></pre>
<p>Now let’s come back to React, we need to create the <code>UI3DContext</code> and defined a component to provide the context provider.</p>
<div class='preCodeBlock'></div>
<pre><code class="language-Typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> UI3DContext = React.createContext(UI3DStateSchema.identity);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> UI3DContainerProps = {
    <span class="hljs-attr">state</span>:UI3DContext;
};
<span class="hljs-comment">// define the UI3DContainer component to provide UI3DContext.Provider</span>
<span class="hljs-comment">// the reason why we don&#x27;t call UI3DContext.Provider directly is because </span>
<span class="hljs-comment">// we want to manage our UI3d state with the help of the React component&#x27;s lifecycle method.</span>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UI3DContainer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span>&lt;<span class="hljs-title">UI3DContainerProps</span>, </span>{}&gt; {
    <span class="hljs-keyword">private</span> _node:UI3DEventHandlerNode|<span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-title">componentWillUnmount</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-keyword">const</span> ui3d = <span class="hljs-built_in">this</span>.props.state;
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>._node) {
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>._node === ui3d.eventHandlers) {
                ui3d.eventHandlers = <span class="hljs-built_in">this</span>._node.next;
            }
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>._node.next) {
                <span class="hljs-built_in">this</span>._node.next.prev = <span class="hljs-built_in">this</span>._node.prev;
            }
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>._node.prev) {
                <span class="hljs-built_in">this</span>._node.prev.next = <span class="hljs-built_in">this</span>._node.next;
            }
            <span class="hljs-built_in">this</span>._node = <span class="hljs-literal">null</span>;
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-title">render</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-keyword">const</span> ui3d = <span class="hljs-built_in">this</span>.props.state;
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>._node) {
            <span class="hljs-built_in">this</span>._node = <span class="hljs-keyword">new</span> UI3DEventHandlerNode();
            <span class="hljs-built_in">this</span>._node.next = ui3d.eventHandlers;
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>._node.next) {
                <span class="hljs-built_in">this</span>._node.next.prev = <span class="hljs-built_in">this</span>._node;
            }
            <span class="hljs-built_in">this</span>._node.prev = <span class="hljs-literal">null</span>;
            ui3d.eventHandlers = <span class="hljs-built_in">this</span>._node;
        }

        <span class="hljs-keyword">return</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UI3DContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{this.props.state}</span>&gt;</span>
                {this.props.children}
            <span class="hljs-tag">&lt;/<span class="hljs-name">UI3DContext.Provider</span>&gt;</span></span>
        );
    }
}
</code></pre>
<p>Now, we can create the actual 3dUI component of 3d Point, remember, from React’s perspective, it is a UI3DContext.Comsumer and a EliminateWrapper.</p>
<div class='preCodeBlock'></div>
<pre><code class="language-Typescript"><span class="hljs-keyword">interface</span> EliminateWrapperProps {
    <span class="hljs-attr">elements</span>:UI3DElement[];
    element:UI3DElement;
    clearMethod:<span class="hljs-function">(<span class="hljs-params">fn:() =&gt; <span class="hljs-built_in">void</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EliminateWrapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span>&lt;<span class="hljs-title">EliminateWrapperProps</span>, </span>{}&gt; {
    <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params">props</span>)</span> {
        <span class="hljs-built_in">super</span>(props);
        <span class="hljs-built_in">this</span>.componentWillUnMount = <span class="hljs-built_in">this</span>.componentWillUnMount.bind(<span class="hljs-built_in">this</span>);
    }

    <span class="hljs-comment">// this is very strange, that componentWillUnMount will not be called by react when the component is in the Consumer</span>
    <span class="hljs-comment">// I have search a lot but could not find much resources about it, that why it end up call by an hook from parent ....</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-title">componentWillUnMount</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">this</span>.props.elements.length;  i++) {
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.props.elements[i].data.id === <span class="hljs-built_in">this</span>.props.element.data.id) {
                <span class="hljs-built_in">this</span>.props.elements.splice(i, <span class="hljs-number">1</span>);
                <span class="hljs-keyword">break</span>;
            }
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-title">componentDidMount</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-built_in">this</span>.props.klarMethod(<span class="hljs-built_in">this</span>.componentWillUnMount);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-title">render</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span>;
    }
}

<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">UI3DContextWrapper</span>&lt;<span class="hljs-title">Props</span>, <span class="hljs-title">ElementType</span> <span class="hljs-title">extends</span> <span class="hljs-title">keyof</span> <span class="hljs-title">typeof</span> <span class="hljs-title">UI3DElementSchema</span>.<span class="hljs-title">muData</span>, <span class="hljs-title">Schema</span> <span class="hljs-title">extends</span> <span class="hljs-title">MuSchema</span>&lt;<span class="hljs-title">any</span>&gt;&gt;(<span class="hljs-params">
    schema:Schema,
    elementType:ElementType,
    factory:(element:<span class="hljs-keyword">typeof</span> UI3DElementSchema.muData[ElementType][<span class="hljs-string">&#x27;identity&#x27;</span>], props:Props, state:<span class="hljs-keyword">typeof</span> UI3DStateSchema[<span class="hljs-string">&#x27;identity&#x27;</span>]) =&gt; <span class="hljs-built_in">void</span></span>) </span>{

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UI3DContextInjector</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span>&lt;<span class="hljs-title">Props</span>, </span>{}&gt; {

        <span class="hljs-keyword">private</span> _element?:<span class="hljs-literal">null</span>|UI3DElement;
        <span class="hljs-keyword">private</span> _clearData:<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span> = <span class="hljs-function">() =&gt;</span> {};

        <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-title">clearMethod</span>(<span class="hljs-params">childUmont:() =&gt; <span class="hljs-built_in">void</span></span>)</span> {
            <span class="hljs-built_in">this</span>._clearData = childUmont;
        }

        <span class="hljs-title">constructor</span> (<span class="hljs-params">props</span>) {
            <span class="hljs-built_in">super</span>(props);
            <span class="hljs-built_in">this</span>.klarMethod = <span class="hljs-built_in">this</span>.klarMethod.bind(<span class="hljs-built_in">this</span>);
        }

        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-title">componentWillUnmount</span>(<span class="hljs-params"></span>)</span> {
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>._element) {
                <span class="hljs-built_in">this</span>._element.data.destroyed = <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>._clearData) {
                    <span class="hljs-built_in">this</span>._clearData();
                }
                <span class="hljs-built_in">this</span>._element = <span class="hljs-literal">null</span>;
            }
        }

        <span class="hljs-keyword">public</span> render () {
            <span class="hljs-keyword">return</span> (
                <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UI3DContext.Consumer</span>&gt;</span>
                    {(context) =&gt; {
                        if (this._element) {
                            factory(this._element.data, this.props, context);
                        } else {
                            const element = UI3DElementSchema.alloc();
                            element.type = elementType;
                            const data = element.data = schema.clone(schema.identity);
                            data.id = context.idCounter++;
                            data.destroyed = false;
                            this._element = element;
                            context.elements.push(element);
                            factory(data, this.props, context);
                        }
                        return <span class="hljs-tag">&lt;<span class="hljs-name">EliminateWrapper</span> <span class="hljs-attr">elements</span>=<span class="hljs-string">{context.elements}</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{this._element}</span> <span class="hljs-attr">clearMethod</span>=<span class="hljs-string">{this.clearMethod}/</span>&gt;</span>;
                    }}
                <span class="hljs-tag">&lt;/<span class="hljs-name">UI3DContext.Consumer</span>&gt;</span></span>
            );
        }
    }
    <span class="hljs-keyword">return</span> UI3DContextInjector;
}
</code></pre>
<p>Look closely at UI3DContextInjector’s render function, the ui3d element is created in the UI3DContext.Consumer, and the element will be add into UI3D State, it will also pass into EliminateWrapper as a prop.
Finally, we can defined UI3DPoint component</p>
<div class='preCodeBlock'></div>
<pre><code class="language-Typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> UI3DPoint = UI3DContextWrapper(UI3DSphereSchema, <span class="hljs-string">&#x27;point&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">
    element,
    props:{
        position:vec3,
        radius?:<span class="hljs-built_in">number</span>,
        color?:vec3,
        onMouse?:UI3DMouseHandler,
    },
    context</span>) =&gt;</span> {
    vec3.copy(element.position, props.position);
    <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;color&#x27;</span> <span class="hljs-keyword">in</span> props) {
        vec3.copy(element.color, (props.color <span class="hljs-keyword">as</span> vec3));
    } <span class="hljs-keyword">else</span> {
        vec3.set(element.color, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;radius&#x27;</span> <span class="hljs-keyword">in</span> props) {
        element.radius = (props.radius <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>);
    } <span class="hljs-keyword">else</span> {
        element.radius = <span class="hljs-number">1</span>;
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;onMouse&#x27;</span> <span class="hljs-keyword">in</span> props) {
        element.onMouseChange = (props.onMouse <span class="hljs-keyword">as</span> UI3DMouseHandler);
    } <span class="hljs-keyword">else</span> {
        element.onMouseChange = <span class="hljs-literal">null</span>;
    }
});
</code></pre>
<p>And this is how we can use it:</p>
<div class='preCodeBlock'></div>
<pre><code class="language-Html"><span class="hljs-tag">&lt;<span class="hljs-name">UI3DContainer</span> <span class="hljs-attr">state</span>=<span class="hljs-string">{ui3dState}</span>&gt;</span>
    ...
    <span class="hljs-tag">&lt;<span class="hljs-name">UI3DPoint</span>
        <span class="hljs-attr">position</span>=<span class="hljs-string">{[5,</span> <span class="hljs-attr">5.5</span>, <span class="hljs-attr">5</span>]}
        <span class="hljs-attr">radius</span>=<span class="hljs-string">{2}</span>
        <span class="hljs-attr">color</span>=<span class="hljs-string">{[1,0,0]}</span>
        <span class="hljs-attr">onMouse</span>=<span class="hljs-string">{(ev)</span> =&gt;</span> {
            ....
        }}
    &gt;<span class="hljs-tag">&lt;/<span class="hljs-name">UI3DPoint</span>&gt;</span>
    ...
<span class="hljs-tag">&lt;/<span class="hljs-name">UI3DContainer</span>&gt;</span>
</code></pre>
<p>With this design, you can easily combine multiple 3d components into one more advanced component. This can be done with React, without modifying any WebGL-related code. Here are examples of our 3d component.</p>
<div class='m-5'></div>
<video controls="true" alt="ui adaption" style="width:600px; margin:auto">
    <source src="/images/3d-ui/ui3d-demo.mp4">
</video>
<div class='m-5'></div></div></article><div class="layout_backToHome__1vZsp"><a href="/">← Back to home</a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"3d-ui","contentHtml":"\u003cdiv class='markdown'\u003e\u003c/div\u003e\n\u003ch2 class=\"text-xl font-medium mb-2 mt-3\"\u003eCombine Webgl and React to create 3d UI\u003c/h2\u003e\n\u003cp\u003eIn modeling software and game editors, 3dUI is an indispensable part, through which user can intuitively manipulate the objects they edit. Some common 3dUIs are looks like:\u003c/p\u003e\n\u003cdiv class='m-5'\u003e\u003c/div\u003e\n\u003cimg src=\"/images/3d-ui/manipulators.png\" alt=\"common 3dUIs\" style=\"width:800px; margin:auto\"/\u003e\n\u003cdiv class='m-5'\u003e\u003c/div\u003e\n\u003cp\u003eIn the Box3 game editor, we also need such manipulators. If we think about it a little bit, we will find that these 3d ui and ordinary React components actually have a lot in common. For example, they can be easily created and destroyed, they can accept props to calculate the initial state, and they have to actively respond to the user’s actions (translation, rotation, scale).\u003c/p\u003e\n\u003cdiv class='m-5'\u003e\u003c/div\u003e\n\u003cp\u003eThat why we want to use the lifecycle of traditional React components to control the creation and destruction of 3d UI. But here’s another problem, the data used in webgl is outside of React, but with the React Context API, we can inject that data into React.\u003c/p\u003e\n\u003cdiv class='m-5'\u003e\u003c/div\u003e\n\u003cp\u003eHere is the diagram show how this system was designed.\u003c/p\u003e\n\u003cdiv class='m-5'\u003e\u003c/div\u003e\n\u003cimg src=\"/images/3d-ui/diagram.png\" alt=\"system design diagram\" style=\"width:500px; margin:auto\"/\u003e\n\u003cdiv class='m-5'\u003e\u003c/div\u003e\n\u003ch3 class=\"text-xl font-medium mb-2 mt-3\"\u003eSo, what exactly is a 3dUI? \u003c/h3\u003e\n\u003cdiv class='m-5'\u003e\u003c/div\u003e\n\u003cp\u003eIf you look at it from a React’s perspective, the combination of a \u003ccode\u003eUI3DContext.Consumer\u003c/code\u003e and a \u003ccode\u003eEliminateWrapper\u003c/code\u003e in the diagram is a 3dUI component. If you look at it from the perspective of the WebGL rendering engine, then the 3dUI data generated by the \u003ccode\u003eUI3DContext.Consumer\u003c/code\u003e is actually a 3dUI Element.\u003c/p\u003e\n\u003cp\u003eAt the specific code implementation level, we use \u003ca class=\"text-blue-700\" href=\"https://github.com/mikolalysenko/mudb\"\u003eMudb\u003c/a\u003e to build the schema of UI3dState.(Mudb is the core opensource library that we use in ‘Box3’, it was build by our team). You may use any method you like, but the overall design pattern has shown in the diagram.\u003c/p\u003e\n\u003cp\u003eThe simplest example would be a 3d Point(or you can call it Sphere), I will use it for a detailed demonstration.\nFirst, we define the schema for UI3DState and UI3DSphere.\u003c/p\u003e\n\u003cdiv class='preCodeBlock'\u003e\u003c/div\u003e\n\u003cpre\u003e\u003ccode class=\"language-Typescript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// define mouse event schema\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e UI3DMouseEventSchema = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e MuStruct({\n    \u003cspan class=\"hljs-attr\"\u003eeye\u003c/span\u003e: Vec3Schema,\n    \u003cspan class=\"hljs-attr\"\u003emouseButton\u003c/span\u003e: \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e MuUint8(),\n    \u003cspan class=\"hljs-attr\"\u003emouseState\u003c/span\u003e: \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e MuUint8(),\n    \u003cspan class=\"hljs-attr\"\u003eworldPosition\u003c/span\u003e: Vec3Schema,\n    \u003cspan class=\"hljs-attr\"\u003escreenPosition\u003c/span\u003e: Vec2Schema,\n});\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003etype\u003c/span\u003e UI3DMouseEvent = \u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e UI3DMouseEventSchema.identity;\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003etype\u003c/span\u003e UI3DMouseHandler = \u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003eevent:UI3DMouseEvent\u003c/span\u003e) =\u0026gt;\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003eboolean\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-class\"\u003e\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eUI3DEventHandlerNode\u003c/span\u003e \u003c/span\u003e{\n    \u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e next:UI3DEventHandlerNode|\u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\n    \u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e prev:UI3DEventHandlerNode|\u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\n}\n\n\u003cspan class=\"hljs-comment\"\u003e// Schema for UI3DSphere\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e UI3DSphereSchema = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e MuStruct({\n    \u003cspan class=\"hljs-attr\"\u003eid\u003c/span\u003e: \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e MuUint32(),\n    \u003cspan class=\"hljs-attr\"\u003edestroyed\u003c/span\u003e: \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e MuBoolean(\u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e),\n    \u003cspan class=\"hljs-attr\"\u003eposition\u003c/span\u003e: Vec3Schema,\n    \u003cspan class=\"hljs-attr\"\u003eradius\u003c/span\u003e: \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e MuFloat64(\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e),\n    \u003cspan class=\"hljs-attr\"\u003ecolor\u003c/span\u003e: Vec3Schema,\n    \u003cspan class=\"hljs-attr\"\u003eonMouseChange\u003c/span\u003e: \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e MuRefSchema\u0026lt;UI3DMouseHandler\u0026gt;(),\n});\n\n\u003cspan class=\"hljs-comment\"\u003e// you can define more different kind of UI3DElement\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e UI3DElementSchema = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e MuUnion({\n    \u003cspan class=\"hljs-attr\"\u003epoint\u003c/span\u003e: UI3DSphereSchema,\n});\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003etype\u003c/span\u003e UI3DElement = \u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e UI3DElementSchema.identity;\n\n\u003cspan class=\"hljs-comment\"\u003e// an event record\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e UI3DEventSchema = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e MuStruct({\n    \u003cspan class=\"hljs-comment\"\u003e// hit distance\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003ehitDistance\u003c/span\u003e: \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e MuFloat64(),\n    \u003cspan class=\"hljs-comment\"\u003e// event type\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eevent\u003c/span\u003e: \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e MuUnion({\n        \u003cspan class=\"hljs-attr\"\u003emouse\u003c/span\u003e: UI3DMouseEventSchema,\n    }),\n    \u003cspan class=\"hljs-comment\"\u003e// event handler\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003ehandler\u003c/span\u003e: \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e MuRefSchema\u0026lt;\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003eevent:\u003cspan class=\"hljs-built_in\"\u003eany\u003c/span\u003e\u003c/span\u003e) =\u0026gt;\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003eboolean\u003c/span\u003e\u0026gt;(),\n});\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e UI3DEventQueueSchema = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e MuArray(UI3DEventSchema, \u003cspan class=\"hljs-literal\"\u003eInfinity\u003c/span\u003e);\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003etype\u003c/span\u003e UI3DEventQueue = \u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e UI3DEventQueueSchema.identity;\n\n\u003cspan class=\"hljs-comment\"\u003e// Schema for UI3DState\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e UI3DStateSchema = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e MuStruct({\n    \u003cspan class=\"hljs-attr\"\u003eidCounter\u003c/span\u003e: \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e MuUint32(),\n\n    \u003cspan class=\"hljs-comment\"\u003e// elements list\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eelements\u003c/span\u003e: \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e MuArray(UI3DElementSchema, \u003cspan class=\"hljs-literal\"\u003eInfinity\u003c/span\u003e),\n\n    \u003cspan class=\"hljs-comment\"\u003e// event handler list\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eeventHandlers\u003c/span\u003e: \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e MuRefSchema\u0026lt;UI3DEventHandlerNode\u0026gt;(),\n\n    \u003cspan class=\"hljs-comment\"\u003e// previous event handler list\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eprevEventStack\u003c/span\u003e: UI3DEventQueueSchema,\n});\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003etype\u003c/span\u003e UI3DState = \u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e UI3DStateSchema.identity;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow let’s come back to React, we need to create the \u003ccode\u003eUI3DContext\u003c/code\u003e and defined a component to provide the context provider.\u003c/p\u003e\n\u003cdiv class='preCodeBlock'\u003e\u003c/div\u003e\n\u003cpre\u003e\u003ccode class=\"language-Typescript\"\u003e\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e UI3DContext = React.createContext(UI3DStateSchema.identity);\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003etype\u003c/span\u003e UI3DContainerProps = {\n    \u003cspan class=\"hljs-attr\"\u003estate\u003c/span\u003e:UI3DContext;\n};\n\u003cspan class=\"hljs-comment\"\u003e// define the UI3DContainer component to provide UI3DContext.Provider\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e// the reason why we don\u0026#x27;t call UI3DContext.Provider directly is because \u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e// we want to manage our UI3d state with the help of the React component\u0026#x27;s lifecycle method.\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-class\"\u003e\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eUI3DContainer\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eReact\u003c/span\u003e.\u003cspan class=\"hljs-title\"\u003eComponent\u003c/span\u003e\u0026lt;\u003cspan class=\"hljs-title\"\u003eUI3DContainerProps\u003c/span\u003e, \u003c/span\u003e{}\u0026gt; {\n    \u003cspan class=\"hljs-keyword\"\u003eprivate\u003c/span\u003e _node:UI3DEventHandlerNode|\u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\n\n    \u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-title\"\u003ecomponentWillUnmount\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e)\u003c/span\u003e {\n        \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e ui3d = \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e.props.state;\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e._node) {\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e._node === ui3d.eventHandlers) {\n                ui3d.eventHandlers = \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e._node.next;\n            }\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e._node.next) {\n                \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e._node.next.prev = \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e._node.prev;\n            }\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e._node.prev) {\n                \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e._node.prev.next = \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e._node.next;\n            }\n            \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e._node = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\n        }\n    }\n\n    \u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-title\"\u003erender\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e)\u003c/span\u003e {\n        \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e ui3d = \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e.props.state;\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!\u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e._node) {\n            \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e._node = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e UI3DEventHandlerNode();\n            \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e._node.next = ui3d.eventHandlers;\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e._node.next) {\n                \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e._node.next.prev = \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e._node;\n            }\n            \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e._node.prev = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\n            ui3d.eventHandlers = \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e._node;\n        }\n\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e (\n            \u003cspan class=\"xml\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003eUI3DContext.Provider\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003evalue\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e{this.props.state}\u003c/span\u003e\u0026gt;\u003c/span\u003e\n                {this.props.children}\n            \u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003eUI3DContext.Provider\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n        );\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow, we can create the actual 3dUI component of 3d Point, remember, from React’s perspective, it is a UI3DContext.Comsumer and a EliminateWrapper.\u003c/p\u003e\n\u003cdiv class='preCodeBlock'\u003e\u003c/div\u003e\n\u003cpre\u003e\u003ccode class=\"language-Typescript\"\u003e\u003cspan class=\"hljs-keyword\"\u003einterface\u003c/span\u003e EliminateWrapperProps {\n    \u003cspan class=\"hljs-attr\"\u003eelements\u003c/span\u003e:UI3DElement[];\n    element:UI3DElement;\n    clearMethod:\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003efn:() =\u0026gt; \u003cspan class=\"hljs-built_in\"\u003evoid\u003c/span\u003e\u003c/span\u003e) =\u0026gt;\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003evoid\u003c/span\u003e;\n}\n\n\u003cspan class=\"hljs-class\"\u003e\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eEliminateWrapper\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eReact\u003c/span\u003e.\u003cspan class=\"hljs-title\"\u003eComponent\u003c/span\u003e\u0026lt;\u003cspan class=\"hljs-title\"\u003eEliminateWrapperProps\u003c/span\u003e, \u003c/span\u003e{}\u0026gt; {\n    \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-title\"\u003econstructor\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eprops\u003c/span\u003e)\u003c/span\u003e {\n        \u003cspan class=\"hljs-built_in\"\u003esuper\u003c/span\u003e(props);\n        \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e.componentWillUnMount = \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e.componentWillUnMount.bind(\u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e);\n    }\n\n    \u003cspan class=\"hljs-comment\"\u003e// this is very strange, that componentWillUnMount will not be called by react when the component is in the Consumer\u003c/span\u003e\n    \u003cspan class=\"hljs-comment\"\u003e// I have search a lot but could not find much resources about it, that why it end up call by an hook from parent ....\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-title\"\u003ecomponentWillUnMount\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e)\u003c/span\u003e {\n        \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e (\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e i=\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e; i \u0026lt; \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e.props.elements.length;  i++) {\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e.props.elements[i].data.id === \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e.props.element.data.id) {\n                \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e.props.elements.splice(i, \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e);\n                \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\n            }\n        }\n    }\n\n    \u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-title\"\u003ecomponentDidMount\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e)\u003c/span\u003e {\n        \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e.props.klarMethod(\u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e.componentWillUnMount);\n    }\n\n    \u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-title\"\u003erender\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e)\u003c/span\u003e {\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x27;\u0026#x27;\u003c/span\u003e;\n    }\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eUI3DContextWrapper\u003c/span\u003e\u0026lt;\u003cspan class=\"hljs-title\"\u003eProps\u003c/span\u003e, \u003cspan class=\"hljs-title\"\u003eElementType\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eextends\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003ekeyof\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003etypeof\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eUI3DElementSchema\u003c/span\u003e.\u003cspan class=\"hljs-title\"\u003emuData\u003c/span\u003e, \u003cspan class=\"hljs-title\"\u003eSchema\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eextends\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eMuSchema\u003c/span\u003e\u0026lt;\u003cspan class=\"hljs-title\"\u003eany\u003c/span\u003e\u0026gt;\u0026gt;(\u003cspan class=\"hljs-params\"\u003e\n    schema:Schema,\n    elementType:ElementType,\n    factory:(element:\u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e UI3DElementSchema.muData[ElementType][\u003cspan class=\"hljs-string\"\u003e\u0026#x27;identity\u0026#x27;\u003c/span\u003e], props:Props, state:\u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e UI3DStateSchema[\u003cspan class=\"hljs-string\"\u003e\u0026#x27;identity\u0026#x27;\u003c/span\u003e]) =\u0026gt; \u003cspan class=\"hljs-built_in\"\u003evoid\u003c/span\u003e\u003c/span\u003e) \u003c/span\u003e{\n\n    \u003cspan class=\"hljs-class\"\u003e\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eUI3DContextInjector\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eReact\u003c/span\u003e.\u003cspan class=\"hljs-title\"\u003eComponent\u003c/span\u003e\u0026lt;\u003cspan class=\"hljs-title\"\u003eProps\u003c/span\u003e, \u003c/span\u003e{}\u0026gt; {\n\n        \u003cspan class=\"hljs-keyword\"\u003eprivate\u003c/span\u003e _element?:\u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e|UI3DElement;\n        \u003cspan class=\"hljs-keyword\"\u003eprivate\u003c/span\u003e _clearData:\u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003evoid\u003c/span\u003e = \u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {};\n\n        \u003cspan class=\"hljs-keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-title\"\u003eclearMethod\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003echildUmont:() =\u0026gt; \u003cspan class=\"hljs-built_in\"\u003evoid\u003c/span\u003e\u003c/span\u003e)\u003c/span\u003e {\n            \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e._clearData = childUmont;\n        }\n\n        \u003cspan class=\"hljs-title\"\u003econstructor\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003eprops\u003c/span\u003e) {\n            \u003cspan class=\"hljs-built_in\"\u003esuper\u003c/span\u003e(props);\n            \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e.klarMethod = \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e.klarMethod.bind(\u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e);\n        }\n\n        \u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-title\"\u003ecomponentWillUnmount\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e)\u003c/span\u003e {\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e._element) {\n                \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e._element.data.destroyed = \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e;\n                \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e._clearData) {\n                    \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e._clearData();\n                }\n                \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e._element = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\n            }\n        }\n\n        \u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e render () {\n            \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e (\n                \u003cspan class=\"xml\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003eUI3DContext.Consumer\u003c/span\u003e\u0026gt;\u003c/span\u003e\n                    {(context) =\u0026gt; {\n                        if (this._element) {\n                            factory(this._element.data, this.props, context);\n                        } else {\n                            const element = UI3DElementSchema.alloc();\n                            element.type = elementType;\n                            const data = element.data = schema.clone(schema.identity);\n                            data.id = context.idCounter++;\n                            data.destroyed = false;\n                            this._element = element;\n                            context.elements.push(element);\n                            factory(data, this.props, context);\n                        }\n                        return \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003eEliminateWrapper\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eelements\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e{context.elements}\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eelement\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e{this._element}\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eclearMethod\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e{this.clearMethod}/\u003c/span\u003e\u0026gt;\u003c/span\u003e;\n                    }}\n                \u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003eUI3DContext.Consumer\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n            );\n        }\n    }\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e UI3DContextInjector;\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eLook closely at UI3DContextInjector’s render function, the ui3d element is created in the UI3DContext.Consumer, and the element will be add into UI3D State, it will also pass into EliminateWrapper as a prop.\nFinally, we can defined UI3DPoint component\u003c/p\u003e\n\u003cdiv class='preCodeBlock'\u003e\u003c/div\u003e\n\u003cpre\u003e\u003ccode class=\"language-Typescript\"\u003e\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e UI3DPoint = UI3DContextWrapper(UI3DSphereSchema, \u003cspan class=\"hljs-string\"\u003e\u0026#x27;point\u0026#x27;\u003c/span\u003e, \u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003e\n    element,\n    props:{\n        position:vec3,\n        radius?:\u003cspan class=\"hljs-built_in\"\u003enumber\u003c/span\u003e,\n        color?:vec3,\n        onMouse?:UI3DMouseHandler,\n    },\n    context\u003c/span\u003e) =\u0026gt;\u003c/span\u003e {\n    vec3.copy(element.position, props.position);\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-string\"\u003e\u0026#x27;color\u0026#x27;\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e props) {\n        vec3.copy(element.color, (props.color \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e vec3));\n    } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\n        vec3.set(element.color, \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e);\n    }\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-string\"\u003e\u0026#x27;radius\u0026#x27;\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e props) {\n        element.radius = (props.radius \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003enumber\u003c/span\u003e);\n    } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\n        element.radius = \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\n    }\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-string\"\u003e\u0026#x27;onMouse\u0026#x27;\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e props) {\n        element.onMouseChange = (props.onMouse \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e UI3DMouseHandler);\n    } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\n        element.onMouseChange = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\n    }\n});\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAnd this is how we can use it:\u003c/p\u003e\n\u003cdiv class='preCodeBlock'\u003e\u003c/div\u003e\n\u003cpre\u003e\u003ccode class=\"language-Html\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003eUI3DContainer\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003estate\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e{ui3dState}\u003c/span\u003e\u0026gt;\u003c/span\u003e\n    ...\n    \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003eUI3DPoint\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003eposition\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e{[5,\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003e5.5\u003c/span\u003e, \u003cspan class=\"hljs-attr\"\u003e5\u003c/span\u003e]}\n        \u003cspan class=\"hljs-attr\"\u003eradius\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e{2}\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003ecolor\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e{[1,0,0]}\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003eonMouse\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e{(ev)\u003c/span\u003e =\u0026gt;\u003c/span\u003e {\n            ....\n        }}\n    \u0026gt;\u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003eUI3DPoint\u003c/span\u003e\u0026gt;\u003c/span\u003e\n    ...\n\u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003eUI3DContainer\u003c/span\u003e\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWith this design, you can easily combine multiple 3d components into one more advanced component. This can be done with React, without modifying any WebGL-related code. Here are examples of our 3d component.\u003c/p\u003e\n\u003cdiv class='m-5'\u003e\u003c/div\u003e\n\u003cvideo controls=\"true\" alt=\"ui adaption\" style=\"width:600px; margin:auto\"\u003e\n    \u003csource src=\"/images/3d-ui/ui3d-demo.mp4\"\u003e\n\u003c/video\u003e\n\u003cdiv class='m-5'\u003e\u003c/div\u003e","title":"3D UI of Box3 Game Editor","pic":"/images/3d-ui/1.png","keyword":"React, Context API, WebGL","description":"In Box3 Game Editor, we need 3dUI to control the object, this is how I implement it with React Context API and WebGL","date":"2019-08-12"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"3d-ui"},"buildId":"BG2o25y9GcAKGkSn5eoTt","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-feb8a7604fa7fce626b2.js"></script><script src="/_next/static/chunks/main-fcbdb94e906b93a1f560.js" async=""></script><script src="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" async=""></script><script src="/_next/static/chunks/framework.9d524150d48315f49e80.js" async=""></script><script src="/_next/static/chunks/7a55d4b5.210d3c80a2b0e2401248.js" async=""></script><script src="/_next/static/chunks/commons.ff0a5790a80e83d7223b.js" async=""></script><script src="/_next/static/chunks/pages/_app-5d53db12a2c7a352dba7.js" async=""></script><script src="/_next/static/chunks/df27990eef8845831ef4a3353c0adb327953b68f.b37cb412c978ebbef724.js" async=""></script><script src="/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.a80097bea88316e5b19e.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-dd642f1262e5265a6db6.js" async=""></script><script src="/_next/static/BG2o25y9GcAKGkSn5eoTt/_buildManifest.js" async=""></script><script src="/_next/static/BG2o25y9GcAKGkSn5eoTt/_ssgManifest.js" async=""></script></body></html>