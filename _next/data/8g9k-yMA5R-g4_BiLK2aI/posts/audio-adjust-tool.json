{"pageProps":{"postData":{"id":"audio-adjust-tool","contentHtml":"<h1 class=\"text-3xl font-medium mb-2 mt-3\">Audio Adjustment Tool Of Box3 Game Editor</h1>\n<div class='m-5'></div>\n<img src=\"/images/audio-adjust/audio-upload.gif\" alt=\"audio upload\" style=\"width:400px; margin:auto\"/>\n<div class='m-5'></div>\n<p>This is a tool for uploading and simply processing audio in the box3 game editor. I have written a component specifically for this functionality, which in addition to React, will also involve the WebAudio API and canvas 2d.</p>\n<div class='m-5'></div>\n<p>The main functions of this component include: playing and pausing audio, cropping audio, and providing convenient UI controls and visual feedback for these functions.</p>\n<div class='m-5'></div>\n<p>For those who are not familiar with WebAudio API. All you need to know is the ‘Audio’ we talk about is actually a kind of data buffer that we call <code class='il'>AudioBuffer</code>. Whether it’s playing or cropping or even adding sound effects, it’s all about the buffer in the end.</p>\n<div class='m-5'></div>\n<p>To play an audioBuffer, we need to create an <code class='il'>AudioBufferSourceNode</code>, be noticed, an AudioBufferSourceNode can only be started and stop once. Otherwise, your javascript engine gonna throw an error.</p>\n<div class='m-5'></div>\n<p>Now we clear that we need to implement a class to handle all the operations to the audioBuffer and a React component to handle UI interaction.</p>\n<div class='m-5'></div>\n<p>We can call that  class ‘AudioPlayer’, it needs to support basic <code class='il'>play</code> and <code class='il'>stop</code>, besides, the user may want to start playback from any position of the audio, and the selected interval should support loop playback.</p>\n<div class='preCodeBlock'></div>\n<pre><code class=\"language-TypeScript\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">AudioPlayer</span> </span>{\n    <span class=\"hljs-keyword\">private</span> _state = <span class=\"hljs-string\">&#x27;stopped&#x27;</span>;\n    <span class=\"hljs-keyword\">private</span> _offset = <span class=\"hljs-number\">0</span>;\n    <span class=\"hljs-keyword\">private</span> _startTime = <span class=\"hljs-number\">0</span>;\n    <span class=\"hljs-keyword\">private</span> _finished = <span class=\"hljs-literal\">false</span>;\n    <span class=\"hljs-function\"><span class=\"hljs-title\">constructor</span>(<span class=\"hljs-params\">\n        <span class=\"hljs-keyword\">private</span> audioBuffer:AudioBuffer,\n        <span class=\"hljs-keyword\">private</span> audioContext:AudioContext</span>)</span> {\n    }\n\n    <span class=\"hljs-keyword\">private</span> _loopStart = <span class=\"hljs-number\">0</span>;\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">set</span> <span class=\"hljs-title\">loopStart</span>(<span class=\"hljs-params\">value:<span class=\"hljs-built_in\">number</span></span>) {\n        ...\n    }\n\n    <span class=\"hljs-keyword\">private</span> _loopEnd = <span class=\"hljs-literal\">Infinity</span>;\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">set</span> <span class=\"hljs-title\">loopEnd</span>(<span class=\"hljs-params\">value:<span class=\"hljs-built_in\">number</span></span>) {\n        ...\n    }\n\n    <span class=\"hljs-keyword\">private</span> _loop = <span class=\"hljs-literal\">false</span>;\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">set</span> <span class=\"hljs-title\">loop</span>(<span class=\"hljs-params\">flag:<span class=\"hljs-built_in\">boolean</span></span>) {\n        <span class=\"hljs-built_in\">this</span>._loop = flag;\n    }\n\n    <span class=\"hljs-keyword\">private</span> _source:AudioBufferSourceNode|<span class=\"hljs-literal\">null</span> = <span class=\"hljs-literal\">null</span>;\n\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-function\"><span class=\"hljs-title\">now</span>(<span class=\"hljs-params\"></span>)</span> {\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">this</span>.audioContext.currentTime;\n    }\n\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-title\">start</span>(<span class=\"hljs-params\">startTime?:<span class=\"hljs-built_in\">number</span>, offset?:<span class=\"hljs-built_in\">number</span></span>)</span> {\n        ...\n    }\n\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">get</span> <span class=\"hljs-title\">state</span>() {\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">this</span>._state;\n    }\n\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">get</span> <span class=\"hljs-title\">finished</span>() {\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">this</span>._finished;\n    }\n\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-title\">stop</span>(<span class=\"hljs-params\">time?:<span class=\"hljs-built_in\">number</span></span>)</span> {\n        ...\n    }\n\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-title\">seek</span>(<span class=\"hljs-params\">offset:<span class=\"hljs-built_in\">number</span>, time:<span class=\"hljs-built_in\">number</span></span>)</span> {\n        ...\n    }\n}\n</code></pre>\n<p>The start method receives two optional params, <code class='il'>startTime</code> refer to the global time of ‘AudioContex’, if you want to start at the time you call the method, just pass  <code class='il'>audioContext.currentTime</code> to it. <code class='il'>offset</code> refers to the duration of the audio. If an audio is 1.5s long and you want to start playback from the 0.5s, then the <code class='il'>offset</code> is 0.5 .</p>\n<p>Here is how I implement the <code class='il'>start</code> and <code class='il'>stop</code>method:</p>\n<div class='preCodeBlock'></div>\n<pre><code class=\"language-TypeScript\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-title\">start</span>(<span class=\"hljs-params\">startTime?:<span class=\"hljs-built_in\">number</span>, offset?:<span class=\"hljs-built_in\">number</span></span>)</span> {\n    <span class=\"hljs-keyword\">if</span> (startTime === <span class=\"hljs-literal\">undefined</span>) {\n        startTime = <span class=\"hljs-built_in\">this</span>.now();\n    }\n    <span class=\"hljs-keyword\">if</span> (offset === <span class=\"hljs-literal\">undefined</span>) {\n        <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">this</span>._loop) {\n            offset = <span class=\"hljs-built_in\">this</span>._loopStart;\n        } <span class=\"hljs-keyword\">else</span> {\n            offset = <span class=\"hljs-number\">0</span>;\n        }\n    }\n    <span class=\"hljs-built_in\">this</span>._source = <span class=\"hljs-built_in\">this</span>.audioContext.createBufferSource();\n    <span class=\"hljs-built_in\">this</span>._source.connect(<span class=\"hljs-built_in\">this</span>.audioContext.destination);\n    <span class=\"hljs-built_in\">this</span>._source.buffer = <span class=\"hljs-built_in\">this</span>.audioBuffer;\n    <span class=\"hljs-built_in\">this</span>._source.onended = <span class=\"hljs-function\">() =&gt;</span> {\n        <span class=\"hljs-keyword\">const</span> now = <span class=\"hljs-built_in\">this</span>.now();\n        <span class=\"hljs-keyword\">if</span> (!<span class=\"hljs-built_in\">this</span>._loop) {\n            <span class=\"hljs-keyword\">const</span> passTime = (now - <span class=\"hljs-built_in\">this</span>._startTime + <span class=\"hljs-built_in\">this</span>._offset);\n            <span class=\"hljs-keyword\">if</span> (passTime &gt;= <span class=\"hljs-built_in\">this</span>.audioBuffer.duration) {\n                <span class=\"hljs-built_in\">this</span>._finished = <span class=\"hljs-literal\">true</span>;\n            } <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">this</span>.audioBuffer.duration - passTime &gt;= <span class=\"hljs-number\">0</span> &amp;&amp;\n                        <span class=\"hljs-built_in\">this</span>.audioBuffer.duration - passTime &lt;= <span class=\"hljs-number\">1e-4</span>) {\n                <span class=\"hljs-built_in\">this</span>._finished = <span class=\"hljs-literal\">true</span>;\n            }\n        }\n    };\n    <span class=\"hljs-built_in\">this</span>._source.loop = <span class=\"hljs-built_in\">this</span>._loop;\n    <span class=\"hljs-built_in\">this</span>._source.loopStart = <span class=\"hljs-built_in\">this</span>._loopStart;\n    <span class=\"hljs-built_in\">this</span>._source.loopEnd = <span class=\"hljs-built_in\">Math</span>.min(<span class=\"hljs-built_in\">this</span>._loopEnd, <span class=\"hljs-built_in\">this</span>.audioBuffer.duration);\n    <span class=\"hljs-built_in\">this</span>._state = <span class=\"hljs-string\">&#x27;started&#x27;</span>;\n    <span class=\"hljs-built_in\">this</span>._source.start(startTime, offset);\n    <span class=\"hljs-built_in\">this</span>._offset = offset;\n    <span class=\"hljs-built_in\">this</span>._startTime = startTime;\n}\n\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-title\">stop</span>(<span class=\"hljs-params\">time?:<span class=\"hljs-built_in\">number</span></span>)</span> {\n    <span class=\"hljs-keyword\">if</span> (time === <span class=\"hljs-literal\">undefined</span>) {\n        time = <span class=\"hljs-built_in\">this</span>.now();\n    }\n    <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">this</span>._source) {\n        <span class=\"hljs-built_in\">this</span>._source.stop(time);\n        <span class=\"hljs-built_in\">this</span>._source.disconnect();\n        <span class=\"hljs-built_in\">this</span>._state = <span class=\"hljs-string\">&#x27;stopped&#x27;</span>;\n    }\n}\n</code></pre>\n<p>As for the <code class='il'>seek</code>, you can simply call <code class='il'>stop</code> then call <code class='il'>start</code> in it.</p>\n<h2 class=\"text-xl font-medium mb-2 mt-3\">Drawing the Waveform</h2>\n<p>Drawing the waveform of audiobuffer is fairly easy. You don’t need to install another package to do it, all you need to do is some simple calculation. Many people like to install a bunch of extra modules to solve a small problem, but I prefer not to install them if I don’t need to. This allows you to keep your code light weight, and you can learn a lot of new things in the process.</p>\n<div class='preCodeBlock'></div>\n<pre><code class=\"language-TypeScript\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">computeWaveForm</span>(<span class=\"hljs-params\">container:HTMLDivElement, buffer:AudioBuffer</span>) </span>{\n    <span class=\"hljs-keyword\">const</span> peaks:<span class=\"hljs-built_in\">number</span>[] = [];\n    <span class=\"hljs-keyword\">const</span> chann0 = (buffer.getChannelData(<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">as</span> <span class=\"hljs-built_in\">ArrayBuffer</span>);\n    <span class=\"hljs-comment\">// const sampleSize = props.buffer.length / props.waveformWidth;</span>\n    <span class=\"hljs-keyword\">const</span> sampleSize = buffer.length / container.clientWidth;\n    <span class=\"hljs-keyword\">const</span> sampleStep = ~~(sampleSize / <span class=\"hljs-number\">10</span>) || <span class=\"hljs-number\">1</span>;\n\n    <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">let</span> i = <span class=\"hljs-number\">0</span>; i &lt; container.clientWidth; i++) {\n    <span class=\"hljs-comment\">// for (let i = 0; i &lt; props.waveformWidth; i++) {</span>\n        <span class=\"hljs-keyword\">const</span> start = ~~(i * sampleSize);\n        <span class=\"hljs-keyword\">const</span> end = ~~(start + sampleSize);\n        <span class=\"hljs-keyword\">let</span> topCount = <span class=\"hljs-number\">0</span>;\n        <span class=\"hljs-keyword\">let</span> bottomCount = <span class=\"hljs-number\">0</span>;\n        <span class=\"hljs-keyword\">let</span> bottom = <span class=\"hljs-number\">0</span>;\n        <span class=\"hljs-keyword\">let</span> top = <span class=\"hljs-number\">0</span>;\n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">var</span> j = start; j &lt; end; j += sampleStep) {\n            <span class=\"hljs-keyword\">const</span> value = chann0[j];\n            <span class=\"hljs-keyword\">if</span> (value &gt; <span class=\"hljs-number\">0</span>) {\n                bottom += value * value;\n                bottomCount++;\n            }\n            <span class=\"hljs-keyword\">if</span> (value &lt; <span class=\"hljs-number\">0</span>) {\n                top += value * value;\n                topCount++;\n            }\n        }\n        peaks[<span class=\"hljs-number\">2</span> * i] = <span class=\"hljs-built_in\">Math</span>.sqrt(bottom / bottomCount) * <span class=\"hljs-number\">256</span>;\n        peaks[<span class=\"hljs-number\">2</span> * i + <span class=\"hljs-number\">1</span>] = -<span class=\"hljs-built_in\">Math</span>.sqrt(top / topCount) * <span class=\"hljs-number\">256</span>;\n    }\n    <span class=\"hljs-keyword\">return</span> peaks;\n}\n\n<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">drawWaveForm</span>(<span class=\"hljs-params\">canvasEle:HTMLCanvasElement, container:HTMLDivElement, peaks:<span class=\"hljs-built_in\">number</span>[], waveformHeight:<span class=\"hljs-built_in\">number</span></span>) </span>{\n    <span class=\"hljs-keyword\">if</span> (canvasEle &amp;&amp; container) {\n        <span class=\"hljs-keyword\">const</span> cvsCtx = canvasEle.getContext(<span class=\"hljs-string\">&#x27;2d&#x27;</span>);\n        <span class=\"hljs-keyword\">if</span> (cvsCtx) {\n            <span class=\"hljs-keyword\">let</span> dirty = <span class=\"hljs-literal\">false</span>;\n            <span class=\"hljs-keyword\">if</span> (canvasEle.height !== waveformHeight) {\n                dirty = <span class=\"hljs-literal\">true</span>;\n                canvasEle.style.height = waveformHeight + <span class=\"hljs-string\">&#x27;px&#x27;</span>;\n                canvasEle.height = waveformHeight;\n            }\n            <span class=\"hljs-keyword\">if</span> (canvasEle.width !== container.clientWidth) {\n                dirty = <span class=\"hljs-literal\">true</span>;\n                canvasEle.style.width = container.clientWidth + <span class=\"hljs-string\">&#x27;px&#x27;</span>;\n                canvasEle.width = container.clientWidth;\n            }\n            <span class=\"hljs-keyword\">if</span> (dirty) {\n                cvsCtx.translate(<span class=\"hljs-number\">.5</span>, waveformHeight / <span class=\"hljs-number\">2</span>);\n                cvsCtx.scale(<span class=\"hljs-number\">.5</span>, waveformHeight / <span class=\"hljs-number\">256</span>);\n                cvsCtx.lineWidth = <span class=\"hljs-number\">2</span>;\n            } <span class=\"hljs-keyword\">else</span> {\n                cvsCtx.setTransform(<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">0</span>);\n                cvsCtx.translate(<span class=\"hljs-number\">.5</span>, waveformHeight / <span class=\"hljs-number\">2</span>);\n                cvsCtx.scale(<span class=\"hljs-number\">.5</span>, waveformHeight / <span class=\"hljs-number\">256</span>);\n            }\n\n            cvsCtx.clearRect(<span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">0</span>, canvasEle.width, canvasEle.height);\n            cvsCtx.strokeStyle = <span class=\"hljs-string\">&#x27;white&#x27;</span>;\n            cvsCtx.fillStyle = <span class=\"hljs-string\">&#x27;white&#x27;</span>;\n            <span class=\"hljs-keyword\">const</span> start = <span class=\"hljs-number\">0</span>;\n            <span class=\"hljs-keyword\">const</span> end = container.clientWidth;\n            <span class=\"hljs-comment\">// const end = props.waveformWidth;</span>\n            <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">let</span> e = start; e &lt; end; e += <span class=\"hljs-number\">1</span>) {\n                <span class=\"hljs-comment\">// const ptr = 2 * (e % props.waveformWidth);</span>\n                <span class=\"hljs-keyword\">const</span> ptr = <span class=\"hljs-number\">2</span> * (e % container.clientWidth);\n                <span class=\"hljs-keyword\">let</span> xPos = <span class=\"hljs-number\">2</span> * (e - start);\n                <span class=\"hljs-keyword\">let</span> top = peaks[ptr + <span class=\"hljs-number\">1</span>];\n                <span class=\"hljs-keyword\">let</span> bottom = peaks[ptr];\n                <span class=\"hljs-keyword\">if</span> (top &gt;= -<span class=\"hljs-number\">.5</span> &amp;&amp; bottom &lt;= <span class=\"hljs-number\">.5</span>) {\n                    <span class=\"hljs-keyword\">const</span> i = xPos;\n                    <span class=\"hljs-keyword\">for</span> (; e &lt; end; e += <span class=\"hljs-number\">1</span>) {\n                        <span class=\"hljs-comment\">// const a = 2 * (e % props.waveformWidth);</span>\n                        <span class=\"hljs-keyword\">const</span> a = <span class=\"hljs-number\">2</span> * (e % container.clientWidth);\n                        <span class=\"hljs-keyword\">if</span> (peaks[a + <span class=\"hljs-number\">1</span>] &lt; -<span class=\"hljs-number\">.5</span> || peaks[a] &gt; <span class=\"hljs-number\">.5</span>) {\n                            e -= <span class=\"hljs-number\">1</span>;\n                            <span class=\"hljs-keyword\">break</span>;\n                        }\n                        xPos = <span class=\"hljs-number\">2</span> * (e - start);\n                    }\n                    <span class=\"hljs-keyword\">if</span> (i === xPos) {\n                        cvsCtx.moveTo(xPos, -<span class=\"hljs-number\">.5</span>);\n                        cvsCtx.lineTo(xPos, <span class=\"hljs-number\">.5</span>);\n                    } <span class=\"hljs-keyword\">else</span> {\n                        cvsCtx.stroke();\n                        cvsCtx.lineWidth = <span class=\"hljs-number\">1</span>;\n                        cvsCtx.beginPath();\n                        cvsCtx.moveTo(i - <span class=\"hljs-number\">.5</span>, <span class=\"hljs-number\">0</span>);\n                        cvsCtx.lineTo(xPos + <span class=\"hljs-number\">.5</span>, <span class=\"hljs-number\">0</span>);\n                        cvsCtx.stroke();\n                        cvsCtx.lineWidth = <span class=\"hljs-number\">2</span>;\n                        cvsCtx.beginPath();\n                    }\n                } <span class=\"hljs-keyword\">else</span> {\n                    <span class=\"hljs-keyword\">if</span> (top &gt; -<span class=\"hljs-number\">0.5</span>) {\n                        top = -<span class=\"hljs-number\">0.5</span>;\n                    }\n                    <span class=\"hljs-keyword\">if</span> (bottom &lt; <span class=\"hljs-number\">0.5</span>) {\n                        bottom = <span class=\"hljs-number\">0.5</span>;\n                    }\n                    cvsCtx.moveTo(xPos, top);\n                    cvsCtx.lineTo(xPos, bottom);\n                }\n            }\n            cvsCtx.stroke();\n        }\n    }\n}\n</code></pre>\n<p>Besides, there is also a mini music player in Box3 editor implemented in a similar way.</p>\n<div class='m-5'></div>\n<img src=\"/images/audio-adjust/mini-player.gif\" alt=\"mini audio player\" style=\"width:320px; margin:auto\"/>\n<div class='m-5'></div>","title":"Audio Adjustment Tool","pic":"/images/audio-adjust/1.png","keyword":"React, WebAudio API, Canvas","description":"This is a tool for uploading and simply processing audio in the box3 platform. The technology used is React and WebAudio API.","date":"2020-08-10"}},"__N_SSG":true}